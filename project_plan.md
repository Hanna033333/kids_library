# 책자리 – 작업계획서 (for Antigravity)

## 0. 프로젝트 한 줄 요약
책자리는 **아이 책을 고를 때 도서관에서 바로 찾을 수 있도록
청구기호를 함께 제공하는 어린이 도서 탐색 서비스**다.

---

## 1. 지금 단계의 목표
- 베타 서비스 안정화
- 검색 → 리스트 → 책 확인 → 도서관 방문 흐름 완성
- 데이터 정확도 문제를 “신고 + 보완” 구조로 운영

성공 기준:
- 검색 후 책 클릭까지 자연스럽게 이어짐
- 청구기호 오류 신고 플로우가 막히지 않음
- 모바일 기준 사용 가능

---

## 2. 현재 포함 범위 (Scope)
### 포함
- **검색 및 필터링**
  - 제목/저자 기반 검색
  - 카테고리 필터 (그림책, 동화, 지식책 등)
  - 연령 필터 (0-2세, 3-4세, 5-7세, 8~13세)
  - 정렬 (최신순, 제목순)
- **책 리스트**
  - 무한 스크롤 (24권씩 로딩)
  - 책 표지 이미지
- **책 상세 정보**
  - 기본 정보 (제목, 저자, 출판사, ISBN)
  - 청구기호 + 권 정보
  - 실시간 대출 가능 여부
  - 큐레이션 태그
- **홈 추천 섹션**
  - 연령별 추천
  - 어린이도서연구회 추천
  - (향후 확장 예정)
- **도서 구매 연결**
  - 교보문고 구매 링크 (LinkPrice)
- **오류 신고** (구글 폼)

### 제외
- 로그인/회원 기능
- 리뷰/별점
- 개인화 추천
- 결제

---

## 3. 핵심 사용자 흐름
1. 보호자가 책을 찾는다
2. 연령/주제로 리스트를 본다
3. 책을 고른다
4. 청구기호를 보고 도서관에서 찾는다
5. 정보가 틀리면 신고한다

---

## 4. 운영 원칙
- 데이터는 완벽하지 않아도 공개한다
- 대신 **고칠 수 있는 구조**를 먼저 만든다
- 기능 추가보다 “헷갈리지 않음”을 우선한다

---

## 5. 기술 스택
### Frontend
- Next.js (App Router)
- TypeScript
- Tailwind CSS
- React Query (데이터 페칭 및 캐싱)

### Backend
- FastAPI (Python Web Framework)
- Supabase (PostgreSQL Database)
- Render (Backend API Hosting)
- Vercel (Frontend Hosting & Serverless Functions)

### External APIs
- Data4Library API (도서관 소장 정보)
- 판교 도서관 웹사이트 (청구기호 스크래핑)
- 판교 도서관 대출 상태 API (실시간 대출 가능 여부)
- LinkPrice Deep Link (도서 구매 연결)

---

## 6. API 설계

### 6-1. Base URL
- **Production**: `https://api.checkjari.com`
- **Development**: `http://127.0.0.1:8000`
- **API Prefix**: `/api`

> 환경변수 `NEXT_PUBLIC_API_URL`로 설정

### 6-2. 책 관련 API (`/api/books`)

#### GET `/api/books/search`
책 검색 및 필터링

**Query Parameters:**
- `q` (optional): 검색어 (제목, 저자, 키워드)
- `age` (optional): 연령대 (예: '0-2세', '3-4세', '5-7세', '초등 저학년', '초등 고학년')
- `category` (optional): 카테고리 (예: '그림책', '동화', '지식책')
- `sort` (optional): 정렬 기준 ('title' 또는 'pangyo_callno', 기본값: 'pangyo_callno')
- `page` (optional): 페이지 번호 (기본값: 1)
- `limit` (optional): 페이지당 항목 수 (기본값: 20, 최대: 100)

**Response:**
```json
{
  "data": [...],
  "total": 1234,
  "page": 1,
  "limit": 20
}
```

#### GET `/api/books/list`
전체 목록 조회 (pangyo_callno가 있는 책만)

**Query Parameters:**
- `age`, `category`, `sort`, `page`, `limit` (검색 API와 동일)

#### GET `/api/books/{book_id}`
책 상세 정보 조회

**Response:**
- 책 기본 정보
- 청구기호 및 권 정보
- 알라딘 API 도서 소개 (캐싱)
- 찜 횟수

#### POST `/api/books/loan-status`
여러 책의 대출 정보를 병렬로 조회

**Request Body:**
```json
{
  "book_ids": [1, 2, 3, 4, 5]
}
```

**Response:**
```json
{
  "1": { "status": "대출가능", "location": "어린이자료실" },
  "2": { "status": "대출중", "returnDate": "2026-01-15" }
}
```

#### POST `/api/books/by-ids`
여러 책의 상세 정보를 ID로 조회

**Request Body:**
```json
{
  "book_ids": [1, 2, 3]
}
```

### 6-3. 추천 섹션 API

#### GET `/api/recommendations/age/{age_group}`
연령별 추천 도서 목록

#### GET `/api/recommendations/curation/{tag}`
큐레이션 태그별 추천 도서 목록

### 6-4. API 성능 최적화
- **캐싱**: 대출 상태 API는 5분 캐시
- **병렬 처리**: 여러 책의 대출 정보를 비동기로 병렬 조회
- **타임아웃**: 외부 API 호출 시 3-10초 타임아웃 설정
- **에러 핸들링**: 외부 API 실패 시 graceful degradation

---

## 7. 데이터 시스템 구조 (Data System Architecture)

### 7-1. 데이터 흐름 개요
책자리의 데이터는 **“신뢰 가능한 추천 목록 → 도서관 소장/청구기호 매칭 → 사용자 검증(신고)”**의 구조로 운영된다.


### 7-2. 데이터 소스
#### Primary Source
- **어린이도서연구회 추천 도서 목록**
  - 서비스의 “좋은 책” 기준
  - 초기 데이터의 품질 기준점

#### Secondary Source
- **Data4Library API**
  - 소장 여부 확인
  
- **도서관 장서 데이터 (판교 도서관)**
  - 웹 스크래핑을 통한 청구기호 수집
  - 청구기호 보조 검증

- **판교 도서관 대출 상태 API**
  - 실시간 대출 가능 여부 확인
  - 캐시 TTL: 5분

---

### 7-3. 주요 테이블 구조 (Supabase)
#### 1) childbook_items
**기본 정보**
- id (Primary Key)
- title (제목)
- author (저자)
- publisher (출판사)
- isbn (ISBN)
- category (카테고리: 그림책, 동화, 지식책 등)
- age (연령: 0-2세, 3-4세, 5-7세, 초등 저학년, 초등 고학년)
- keywords (검색용 키워드)

**청구기호 관련**
- callno (청구기호 - 최종 사용)
- web_scraped_callno (웹 스크래핑으로 수집한 청구기호)
- vol (권 정보 - 시리즈물의 경우)

**큐레이션 및 메타데이터**
- curation_tag (큐레이션 태그)
- similarity (유사도 점수)
- owned (도서관 소장 여부)

**타임스탬프**
- created_at
- updated_at

**역할:**
- 추천 도서 목록 관리
- 실제 도서관에서 찾기 위한 정보 제공
- 검색 및 필터링 기준 데이터

---

### 7-4. 청구기호 매칭 원칙
- ISBN 기준 매칭을 1차로 사용
- 제목 기반 매칭은 보조 수단으로만 활용
- 자동 매칭 결과는 **완전 신뢰하지 않는다**
- 사용자 신고를 통한 보정 구조를 필수로 둔다

---

### 7-5. 데이터 보정 & 운영 플로우

**청구기호 오류 신고 프로세스:**
1. 사용자가 책 상세 페이지에서 오류 발견
2. 구글 폼을 통해 신고 제출
   - 수집 정보: 올바른 청구기호(텍스트 입력)
3. 운영자가 신고 내용 검토
4. Supabase에서 `childbook_items` 테이블 수동 수정
5. 수정 완료 (자동 반영)

---

### 7-6. 데이터 운영 원칙
- 데이터 정확도보다 **접근성**을 우선
- 불완전한 데이터는 숨기지 않고 상태로 노출
- “틀릴 수 있다”는 전제를 구조로 해결
- 자동화보다 **검증 가능한 흐름**을 유지

---

### 7-7. 향후 확장 가능성 (Future)
- 다중 도서관 지원 (library_code 분리)
- 회원 체계 제공 (가입, 찜, 리뷰 등)
- 책 추가 (큐레이션 확대, 영어 책 추가 등)
- 찜한 도서 공유
- 홈 추천 섹션 확대 (주제별, 계절별, 테마별 등)

---

## 8. 성능 최적화 전략

### 캐싱 전략
- **대출 상태 API**: 5분 캐시 (변동 빈도 고려)
- **책 목록 API**: 서버 사이드 캐싱
- **검색 결과**: React Query 클라이언트 캐싱

### UX 최적화
- 무한 스크롤 (24권씩 점진적 로딩)
- 스켈레톤 로딩 UI (책 리스트, 상세 페이지)
- 이미지 레이지 로딩

---

## 9. 배포 전략 (Deployment Strategy)

### 9-1. 브랜치 전략
- **dev 브랜치**: 개발 및 테스트용 배포
- **main 브랜치**: 프로덕션 배포

### 9-2. 배포 프로세스

#### Frontend (Vercel)
1. **개발 환경 배포**
   - `dev` 브랜치에 푸시
   - Vercel이 자동으로 preview 환경에 배포
   - 테스트 및 검증 수행

2. **프로덕션 배포**
   - 여러 기능을 `dev` 브랜치에서 충분히 테스트
   - 검증 완료 후 승인 요청
   - 승인 받은 후 `main` 브랜치에 일괄 병합
   - Vercel이 자동으로 프로덕션 환경에 배포

#### Backend (Render)
- `main` 브랜치 푸시 시 자동 배포
- 배포 전 로컬 테스트 필수

### 9-3. 배포 원칙
- **점진적 배포**: dev 환경에서 먼저 검증
- **일괄 배포**: 프로덕션은 여러 기능을 모아서 한 번에 배포
- **롤백 가능성**: 문제 발생 시 이전 버전으로 즉시 복구 가능

---

## 10. 알려진 제약사항 및 이슈

### 현재 제약사항
- **단일 도서관 지원**: 현재 판교 도서관만 지원
- **청구기호 정확도**: 자동 매칭의 한계로 인한 오류 가능성
  - 해결책: 사용자 신고 시스템으로 보완
- **Data4Library API 속도**: 외부 API 의존으로 인한 응답 지연 가능성
  - 해결책: 캐싱 및 타임아웃 설정

### 운영 고려사항
- 신고 처리는 현재 수동 운영 (자동화 미구현)
- 대출 상태는 실시간이 아닌 5분 단위 캐시 데이터
- 스크래핑 기반 데이터 수집은 도서관 웹사이트 구조 변경 시 영향받을 수 있음
