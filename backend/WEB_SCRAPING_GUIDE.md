# 웹 스크래핑으로 청구기호 추가하기

## 📋 개요

어린이도서연구회 웹사이트(childbook.org)에서 청구기호를 스크래핑하여 Supabase `childbook_items` 테이블에 추가하는 작업입니다.

## ✅ 현재 상태

- ✅ 웹 스크래핑 스크립트 생성 완료: `scrape_callno_from_web.py`
- ✅ 컬럼 추가 SQL 스크립트 생성 완료: `migrations/add_web_scraped_callno.sql`
- ❌ `web_scraped_callno` 컬럼이 아직 Supabase 테이블에 없음

## 🔧 필요한 작업

### 1단계: Supabase에 컬럼 추가

Supabase 대시보드에서 다음 SQL을 실행해야 합니다:

```sql
ALTER TABLE childbook_items 
ADD COLUMN IF NOT EXISTS web_scraped_callno TEXT;
```

**실행 방법:**
1. https://supabase.com/dashboard 로그인
2. Kids Library 프로젝트 선택
3. 왼쪽 메뉴에서 **SQL Editor** 클릭
4. 위 SQL 코드 붙여넣기 및 실행 (Run 버튼 클릭)

또는 `backend/migrations/add_web_scraped_callno.sql` 파일을 참조하세요.

### 2단계: 웹 스크래핑 실행

컬럼 추가 후, 다음 명령어로 스크래핑을 실행합니다:

```powershell
cd "c:\Users\skplanet\Desktop\kids library\backend"
python scrape_callno_from_web.py
```

## 📂 생성된 파일

### 1. `scrape_callno_from_web.py`
메인 스크래핑 스크립트입니다. 다음 기능을 수행합니다:

- ✅ 어린이도서연구회 추천 도서 페이지에서 책 정보 스크래핑
- ✅ 청구기호 추출 (여러 패턴 지원)
- ✅ DB의 책과 제목으로 매칭
- ✅ `web_scraped_callno` 컬럼에 청구기호 업데이트
- ✅ 첫 페이지만 테스트 (약 20-30권)

**주요 기능:**
- 청구기호 패턴 인식: `813.8-김12ㄱ` 형식
- 제목 기반 매칭으로 DB 책과 연결
- 업데이트 통계 제공

### 2. `migrations/add_web_scraped_callno.sql`
Supabase에서 실행할 SQL 스크립트입니다.

### 3. `add_web_scraped_callno_column.py`
컬럼 존재 여부를 확인하는 헬퍼 스크립트입니다.

### 4. `test_column_exists.py`
간단한 테스트 스크립트로 컬럼이 있는지 확인합니다.

## 🔍 작동 방식

### 스크래핑 프로세스

1. **웹 페이지 요청**
   - URL: `https://www.childbook.org/book/recommend_list.html?p=1`
   - 첫 페이지만 스크래핑 (테스트)

2. **청구기호 추출**
   - 패턴 1: "청구기호:" 텍스트 다음의 값
   - 패턴 2: 정규식으로 `숫자.숫자-한글/영문` 형식 찾기
   - 패턴 3: HTML 구조에서 직접 추출

3. **DB 매칭**
   - DB에서 모든 책 조회
   - 제목으로 매칭 (부분 일치)
   - 매칭된 책의 `web_scraped_callno` 업데이트

4. **결과 출력**
   - 스크래핑한 책 수
   - 청구기호가 있는 책 수
   - DB 매칭 성공 수
   - 업데이트된 책 수

## 📊 예상 결과

```
================================================================================
📚 어린이도서연구회 청구기호 스크래핑
================================================================================

🔧 web_scraped_callno 컬럼 확인 중...
✅ web_scraped_callno 컬럼이 이미 존재합니다.

🔍 첫 페이지 스크래핑 시작...

📡 1 페이지 요청 중...
✅ 1 페이지에서 25권 수집 완료

📊 스크래핑 결과:
  - 총 수집: 25권
  - 청구기호 있음: 18권
  - 청구기호 없음: 7권

🔄 DB 매칭 및 업데이트 시작...

✅ 업데이트: [123] 어린이 책 제목
   └ 청구기호: 813.8-김12ㄱ

================================================================================
📊 최종 결과
================================================================================
  - 스크래핑한 책: 25권
  - 청구기호 있음: 18권
  - 청구기호 없음: 7권
  - DB 매칭 성공: 15권
  - DB 업데이트: 15권
  - 오류: 0건
================================================================================
```

## ⚠️ 주의사항

1. **컬럼 추가 필수**: 먼저 Supabase에서 `web_scraped_callno` 컬럼을 추가해야 합니다.
2. **테스트 모드**: 현재는 첫 페이지만 스크래핑합니다.
3. **매칭 정확도**: 제목 기반 매칭이므로 100% 정확하지 않을 수 있습니다.
4. **인코딩**: Windows에서 한글 출력을 위해 UTF-8 설정이 포함되어 있습니다.

## 🚀 다음 단계

1. ✅ Supabase에 컬럼 추가
2. ✅ 첫 페이지 테스트 실행
3. ⏳ 결과 확인 및 검증
4. ⏳ 필요시 전체 페이지로 확장

## 📝 추가 개선 사항 (선택사항)

- ISBN 기반 매칭 추가로 정확도 향상
- 전체 페이지 스크래핑 옵션
- 중복 업데이트 방지
- 로그 파일 저장
- 진행률 표시

---

**작성일**: 2026-01-02  
**작성자**: Antigravity AI Assistant
